name: Security - Scan Comments for Malicious Content

on:
  issue_comment:
    types: [created, edited]
  discussion_comment:
    types: [created, edited]

jobs:
  scan-malicious-content:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      discussions: write
      pull-requests: write
      
    steps:
      - name: Check for malicious content
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = context.payload.comment.body.toLowerCase();
            const commentId = context.payload.comment.id;
            const issueNumber = context.payload.issue ? context.payload.issue.number : null;
            const discussionNumber = context.payload.discussion ? context.payload.discussion.node_id : null;
            
            // --- Malicious Content Patterns ---
            const maliciousPatterns = [
              // Common executable and script extensions
              /\.exe/g, /\.dll/g, /\.scr/g, /\.bat/g, /\.cmd/g, /\.ps1/g, /\.vbs/g, /\.sh/g, /\.bin/g, /\.apk/g, /\.msi/g,
              // Common archive and disk image extensions
              /\.zip/g, /\.tar/g, /\.gz/g, /\.7z/g, /\.rar/g, /\.iso/g,
              // Suspicious document/macro-enabled file extensions
              /\.pdf/g, /\.doc\b/g, /\.docx\b/g, /\.xls\b/g, /\.xlsx\b/g, /\.ppt\b/g, /\.pptx\b/g, /\.rtf/g,
              // Generic attachment/download keywords
              /attachment/g, /download/g, /file/g, /click here/g,
              // Markdown image/link syntax pointing to suspicious extensions
              /!\[.*?\]\(.*?(\.exe|\.zip|\.dll|\.scr|\.bat|\.cmd|\.ps1|\.vbs|\.sh|\.bin|\.apk|\.msi|\.tar|\.gz|\.7z|\.rar|\.iso|\.pdf|\.doc|\.docx|\.xls|\.xlsx|\.ppt|\.pptx|\.rtf)\)/g,
              /\[.*?\]\(.*?(\.exe|\.zip|\.dll|\.scr|\.bat|\.cmd|\.ps1|\.vbs|\.sh|\.bin|\.apk|\.msi|\.tar|\.gz|\.7z|\.rar|\.iso|\.pdf|\.doc|\.docx|\.xls|\.xlsx|\.ppt|\.pptx|\.rtf)\)/g,
              // Common file hosting/sharing services (can be a sign of external malicious links)
              /drive\.google\.com/g, /dropbox\.com/g, /mega\.nz/g, /mediafire\.com/g, /anonfiles\.com/g,
            ];
            
            let isMalicious = false;
            let matchedPattern = '';
            
            for (const pattern of maliciousPatterns) {
              if (commentBody.match(pattern)) {
                isMalicious = true;
                matchedPattern = pattern.source;
                break;
              }
            }
            
            if (isMalicious) {
              console.log(`Security: Detected malicious content in comment ${commentId}. Pattern: ${matchedPattern}`);
              
              // 1. Delete the comment
              try {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: commentId
                });
                console.log(`Security: Successfully deleted comment ${commentId}.`);
              } catch (error) {
                console.error(`Security: Failed to delete comment ${commentId}. Error: ${error.message}`);
                // Continue to next step even if deletion fails (e.g., due to permissions)
              }
              
              // 2. Post a warning to the issue/discussion (optional but recommended)
              const warningMessage = `**Security Alert:** A comment was automatically deleted from this ${issueNumber ? 'issue' : 'discussion'} because it contained content matching known malicious patterns (e.g., executable files, suspicious links, or common malware keywords). The comment ID was \`${commentId}\`.`;
              
              if (issueNumber) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: warningMessage
                });
              } else if (discussionNumber) {
                // Deleting discussion comments requires a different API call (GraphQL) which is more complex.
                // For simplicity and robustness, we will only delete the comment and log the event.
                // The issue comment API is sufficient for most cases.
                console.log("Security: Discussion comment detected. Skipping automated warning post for simplicity.");
              }
              
              core.setFailed(`Malicious content detected and comment ${commentId} deleted.`);
            } else {
              console.log(`Security: Comment ${commentId} passed scan.`);
            }
            
            // Set output for subsequent steps if needed
            core.setOutput('is_malicious', isMalicious);
