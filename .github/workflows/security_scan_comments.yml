name: Security - Scan Comments for Malicious Content
on:
  issue_comment:
    types:
    - created
    - edited
  discussion_comment:
    types:
    - created
    - edited
jobs:
  scan-malicious-content:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      discussions: write
      pull-requests: write
    steps:
    - name: Check for malicious content
      id: check
      uses: actions/github-script@v7
      with:
        script: "const commentBody = context.payload.comment.body.toLowerCase();\n\
          const commentId = context.payload.comment.id;\nconst issueNumber = context.payload.issue\
          \ ? context.payload.issue.number : null;\nconst discussionNumber = context.payload.discussion\
          \ ? context.payload.discussion.node_id : null;\n\n// --- Malicious Content\
          \ Patterns ---\nconst maliciousPatterns = [\n  // Common executable and\
          \ script extensions\n  /\\.exe/g, /\\.dll/g, /\\.scr/g, /\\.bat/g, /\\.cmd/g,\
          \ /\\.ps1/g, /\\.vbs/g, /\\.sh/g, /\\.bin/g, /\\.apk/g, /\\.msi/g,\n  //\
          \ Common archive and disk image extensions\n  /\\.zip/g, /\\.tar/g, /\\\
          .gz/g, /\\.7z/g, /\\.rar/g, /\\.iso/g,\n  // Suspicious document/macro-enabled\
          \ file extensions\n  /\\.pdf/g, /\\.doc\\b/g, /\\.docx\\b/g, /\\.xls\\b/g,\
          \ /\\.xlsx\\b/g, /\\.ppt\\b/g, /\\.pptx\\b/g, /\\.rtf/g,\n  // Generic attachment/download\
          \ keywords\n  /attachment/g, /download/g, /file/g, /click here/g,\n  //\
          \ Markdown image/link syntax pointing to suspicious extensions\n  /!\\[.*?\\\
          ]\\(.*?(\\.exe|\\.zip|\\.dll|\\.scr|\\.bat|\\.cmd|\\.ps1|\\.vbs|\\.sh|\\\
          .bin|\\.apk|\\.msi|\\.tar|\\.gz|\\.7z|\\.rar|\\.iso|\\.pdf|\\.doc|\\.docx|\\\
          .xls|\\.xlsx|\\.ppt|\\.pptx|\\.rtf)\\)/g,\n  /\\[.*?\\]\\(.*?(\\.exe|\\\
          .zip|\\.dll|\\.scr|\\.bat|\\.cmd|\\.ps1|\\.vbs|\\.sh|\\.bin|\\.apk|\\.msi|\\\
          .tar|\\.gz|\\.7z|\\.rar|\\.iso|\\.pdf|\\.doc|\\.docx|\\.xls|\\.xlsx|\\.ppt|\\\
          .pptx|\\.rtf)\\)/g,\n  // Common file hosting/sharing services (can be a\
          \ sign of external malicious links)\n  /drive\\.google\\.com/g, /dropbox\\\
          .com/g, /mega\\.nz/g, /mediafire\\.com/g, /anonfiles\\.com/g,\n];\n\nlet\
          \ isMalicious = false;\nlet matchedPattern = '';\n\nfor (const pattern of\
          \ maliciousPatterns) {\n  if (commentBody.match(pattern)) {\n    isMalicious\
          \ = true;\n    matchedPattern = pattern.source;\n    break;\n  }\n}\n\n\
          if (isMalicious) {\n  console.log(`Security: Detected malicious content\
          \ in comment ${commentId}. Pattern: ${matchedPattern}`);\n  \n  // 1. Delete\
          \ the comment\n  try {\n    await github.rest.issues.deleteComment({\n \
          \     owner: context.repo.owner,\n      repo: context.repo.repo,\n     \
          \ comment_id: commentId\n    });\n    console.log(`Security: Successfully\
          \ deleted comment ${commentId}.`);\n  } catch (error) {\n    console.error(`Security:\
          \ Failed to delete comment ${commentId}. Error: ${error.message}`);\n  \
          \  // Continue to next step even if deletion fails (e.g., due to permissions)\n\
          \  }\n  \n  // 2. Post a warning to the issue/discussion (optional but recommended)\n\
          \  const warningMessage = `**Security Alert:** A comment was automatically\
          \ deleted from this ${issueNumber ? 'issue' : 'discussion'} because it contained\
          \ content matching known malicious patterns (e.g., executable files, suspicious\
          \ links, or common malware keywords). The comment ID was \\`${commentId}\\\
          `.`;\n  \n  if (issueNumber) {\n    await github.rest.issues.createComment({\n\
          \      owner: context.repo.owner,\n      repo: context.repo.repo,\n    \
          \  issue_number: issueNumber,\n      body: warningMessage\n    });\n  }\
          \ else if (discussionNumber) {\n    // Deleting discussion comments requires\
          \ a different API call (GraphQL) which is more complex.\n    // For simplicity\
          \ and robustness, we will only delete the comment and log the event.\n \
          \   // The issue comment API is sufficient for most cases.\n    console.log(\"\
          Security: Discussion comment detected. Skipping automated warning post for\
          \ simplicity.\");\n  }\n  \n  core.setFailed(`Malicious content detected\
          \ and comment ${commentId} deleted.`);\n} else {\n  console.log(`Security:\
          \ Comment ${commentId} passed scan.`);\n}\n\n// Set output for subsequent\
          \ steps if needed\ncore.setOutput('is_malicious', isMalicious);\n"
    timeout-minutes: 30
permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: read
