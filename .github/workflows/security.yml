name: Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security:
    name: Security Analysis
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci --only=production
        fi
        
    - name: Run security audit
      run: |
        if [ -f package.json ]; then
          npm audit --audit-level=moderate || echo "Security issues found, please review"
        else
          echo "No package.json found, skipping npm audit"
        fi
        
    - name: Check for sensitive files
      run: |
        echo "üîç Checking for sensitive files..."
        
        # Check for common sensitive file patterns
        SENSITIVE_FILES=$(find . -type f \( -name "*.key" -o -name "*.pem" -o -name "*.p12" -o -name "*.pfx" \) -not -path "./.git/*" | head -10)
        
        if [ -n "$SENSITIVE_FILES" ]; then
          echo "‚ö†Ô∏è Potential sensitive files found:"
          echo "$SENSITIVE_FILES"
        else
          echo "‚úÖ No obvious sensitive files detected"
        fi
        
    - name: Basic code scan
      run: |
        echo "üîç Running basic security checks..."
        
        # Check for hardcoded secrets patterns
        if grep -r -i "password\|secret\|key\|token" --include="*.js" --include="*.py" --include="*.json" . | grep -v node_modules | head -5; then
          echo "‚ö†Ô∏è Potential hardcoded secrets found - please review manually"
        else
          echo "‚úÖ No obvious hardcoded secrets detected"
        fi

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
