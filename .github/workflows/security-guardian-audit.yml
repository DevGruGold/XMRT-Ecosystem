name: ðŸ”’ Security Guardian Audit

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    paths:
      - '**/*.py'
      - 'requirements.txt'
      - '.github/workflows/**'

env:
  SECURITY_DIR: 'security_audits'
  PYTHON_VERSION: '3.11'

jobs:
  security-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
      security-events: write
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ”’ Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety pip-audit
    
    - name: ðŸ” Run Bandit security scan
      id: bandit
      run: |
        mkdir -p ${{ env.SECURITY_DIR }}
        bandit -r api/ -f json -o ${{ env.SECURITY_DIR }}/bandit_report.json || true
        bandit -r api/ -f txt > ${{ env.SECURITY_DIR }}/bandit_report.txt || true
      continue-on-error: true
    
    - name: ðŸ” Run Safety dependency check
      id: safety
      run: |
        safety check --json > ${{ env.SECURITY_DIR }}/safety_report.json || true
        safety check > ${{ env.SECURITY_DIR }}/safety_report.txt || true
      continue-on-error: true
    
    - name: ðŸ” Run pip-audit
      id: pip_audit
      run: |
        pip-audit --desc --format json > ${{ env.SECURITY_DIR }}/pip_audit_report.json || true
        pip-audit --desc > ${{ env.SECURITY_DIR }}/pip_audit_report.txt || true
      continue-on-error: true
    
    - name: ðŸ“Š Generate security summary report
      run: |
        python3 << 'EOF'
        import json
        import os
        from datetime import datetime
        
        security_dir = '${{ env.SECURITY_DIR }}'
        os.makedirs(security_dir, exist_ok=True)
        
        # Read reports
        reports = {}
        for report in ['bandit', 'safety', 'pip_audit']:
            json_file = f'{security_dir}/{report}_report.json'
            if os.path.exists(json_file):
                try:
                    with open(json_file, 'r') as f:
                        reports[report] = json.load(f)
                except:
                    reports[report] = {"error": "Failed to parse"}
        
        # Generate markdown summary
        timestamp = datetime.utcnow().isoformat() + 'Z'
        report_file = f'{security_dir}/SECURITY_AUDIT_{datetime.now().strftime("%Y%m%d")}.md'
        
        with open(report_file, 'w') as f:
            f.write(f'# ðŸ”’ Security Guardian Audit Report\n\n')
            f.write(f'**Timestamp:** {timestamp}\n')
            f.write(f'**Trigger:** GitHub Actions (Automated)\n')
            f.write(f'**Agent:** Security Guardian\n\n')
            
            f.write('## ðŸ“‹ Executive Summary\n\n')
            f.write('| Tool | Status | Issues |\n')
            f.write('|------|--------|--------|\n')
            
            # Bandit summary
            if 'bandit' in reports and 'results' in reports['bandit']:
                issue_count = len(reports['bandit']['results'])
                status = 'âš ï¸ Issues Found' if issue_count > 0 else 'âœ… Clean'
                f.write(f'| Bandit (Code Security) | {status} | {issue_count} |\n')
            else:
                f.write(f'| Bandit (Code Security) | âœ… Clean | 0 |\n')
            
            # Safety summary
            if 'safety' in reports:
                vulnerabilities = reports['safety'].get('vulnerabilities', []) if isinstance(reports['safety'], dict) else []
                issue_count = len(vulnerabilities)
                status = 'âš ï¸ Issues Found' if issue_count > 0 else 'âœ… Clean'
                f.write(f'| Safety (Dependencies) | {status} | {issue_count} |\n')
            else:
                f.write(f'| Safety (Dependencies) | âœ… Clean | 0 |\n')
            
            # pip-audit summary  
            if 'pip_audit' in reports:
                vulnerabilities = reports['pip_audit'].get('vulnerabilities', []) if isinstance(reports['pip_audit'], dict) else []
                issue_count = len(vulnerabilities)
                status = 'âš ï¸ Issues Found' if issue_count > 0 else 'âœ… Clean'
                f.write(f'| pip-audit (Supply Chain) | {status} | {issue_count} |\n')
            else:
                f.write(f'| pip-audit (Supply Chain) | âœ… Clean | 0 |\n')
            
            f.write('\n## ðŸ” Detailed Findings\n\n')
            f.write('See individual report files in this directory for complete details:\n\n')
            f.write('- `bandit_report.txt` - Code security analysis\n')
            f.write('- `safety_report.txt` - Dependency vulnerability scan\n')
            f.write('- `pip_audit_report.txt` - Supply chain security\n\n')
            
            f.write('## âœ… Security Guardian Recommendations\n\n')
            f.write('1. Review all findings in detailed reports\n')
            f.write('2. Update vulnerable dependencies immediately\n')
            f.write('3. Address code security issues by priority\n')
            f.write('4. Verify all third-party integrations\n')
            f.write('5. Schedule next audit in 24 hours\n\n')
            
            f.write('---\n')
            f.write('*Automated security audit by Security Guardian Agent*\n')
        
        print(f'âœ… Security summary report created: {report_file}')
        EOF
    
    - name: ðŸ“Š Check for changes
      id: check_changes
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: ðŸ’¾ Commit security audit
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config user.name "Security Guardian"
        git config user.email "security@xmrt-ecosystem.io"
        AUDIT_DATE=$(date -u '+%Y%m%d')
        git add ${{ env.SECURITY_DIR }}
        git commit -m "ðŸ”’ Security Guardian Audit #$AUDIT_DATE [automated]

        âœ… Code security scan completed (Bandit)
        âœ… Dependency vulnerability check (Safety)
        âœ… Supply chain audit (pip-audit)
        ðŸ“Š Security summary generated
        
        Agent: Security Guardian
        Generated by: XMRT Autonomous Security System"
        git push
    
    - name: ðŸ“ˆ Create workflow summary
      if: always()
      run: |
        AUDIT_DATE=$(date -u '+%Y%m%d')
        echo "## ðŸ”’ Security Guardian Audit Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Audit Date:** $AUDIT_DATE" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status == 'success' && 'âœ… Complete' || 'âš ï¸ Issues Found' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ” Scans Performed" >> $GITHUB_STEP_SUMMARY
        echo "- ${{ steps.bandit.outcome == 'success' && 'âœ…' || 'âš ï¸' }} Bandit (Code Security)" >> $GITHUB_STEP_SUMMARY
        echo "- ${{ steps.safety.outcome == 'success' && 'âœ…' || 'âš ï¸' }} Safety (Dependencies)" >> $GITHUB_STEP_SUMMARY
        echo "- ${{ steps.pip_audit.outcome == 'success' && 'âœ…' || 'âš ï¸' }} pip-audit (Supply Chain)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check_changes.outputs.changes }}" = "true" ]; then
          echo "ðŸ“Š **Report Location:** \`${{ env.SECURITY_DIR }}/SECURITY_AUDIT_$AUDIT_DATE.md\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Audit:** In 24 hours (automatic)" >> $GITHUB_STEP_SUMMARY
