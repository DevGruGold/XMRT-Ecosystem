name: üè• Repository Health Check
on:
  schedule:
  - cron: 0 */12 * * *
  workflow_dispatch: null
  push:
    branches:
    - main
env:
  HEALTH_DIR: health_checks
  PYTHON_VERSION: '3.11'
jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: üì¶ Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install requests PyGithub python-dotenv

        '
    - name: üè• Run repository health check
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "python3 << 'EOF'\nimport os\nimport json\nfrom datetime import datetime\n\
        from github import Github, Auth\n\n# Authenticate with GitHub\nauth = Auth.Token(os.environ['GITHUB_TOKEN'])\n\
        g = Github(auth=auth)\n\n# Get repository\nrepo = g.get_repo('DevGruGold/XMRT-Ecosystem')\n\
        \n# Create health directory\nhealth_dir = '${{ env.HEALTH_DIR }}'\nos.makedirs(health_dir,\
        \ exist_ok=True)\n\n# Collect metrics\nhealth_data = {\n    \"timestamp\"\
        : datetime.utcnow().isoformat() + 'Z',\n    \"repository\": {\n        \"\
        name\": repo.full_name,\n        \"stars\": repo.stargazers_count,\n     \
        \   \"forks\": repo.forks_count,\n        \"watchers\": repo.watchers_count,\n\
        \        \"open_issues\": repo.open_issues_count,\n        \"size_kb\": repo.size,\n\
        \        \"default_branch\": repo.default_branch\n    },\n    \"commits\"\
        : {\n        \"total\": repo.get_commits().totalCount,\n        \"this_week\"\
        : len(list(repo.get_commits(since=datetime.utcnow().replace(day=datetime.utcnow().day-7))))\n\
        \    },\n    \"pull_requests\": {\n        \"open\": repo.get_pulls(state='open').totalCount,\n\
        \        \"closed\": repo.get_pulls(state='closed').totalCount\n    },\n \
        \   \"issues\": {\n        \"open\": repo.get_issues(state='open').totalCount,\n\
        \        \"closed\": repo.get_issues(state='closed').totalCount\n    },\n\
        \    \"contributors\": repo.get_contributors().totalCount,\n    \"languages\"\
        : repo.get_languages()\n}\n\n# Save JSON report\nwith open(f'{health_dir}/health_metrics.json',\
        \ 'w') as f:\n    json.dump(health_data, f, indent=2)\n\n# Generate markdown\
        \ report\nreport_date = datetime.now().strftime('%Y%m%d')\nreport_file = f'{health_dir}/HEALTH_CHECK_{report_date}.md'\n\
        \nwith open(report_file, 'w') as f:\n    f.write(f'# \U0001F3E5 Repository\
        \ Health Check Report\\n\\n')\n    f.write(f'**Repository:** {health_data[\"\
        repository\"][\"name\"]}\\n')\n    f.write(f'**Timestamp:** {health_data[\"\
        timestamp\"]}\\n')\n    f.write(f'**Agent:** Eliza (Health Monitor)\\n\\n')\n\
        \    \n    f.write('## \U0001F4CA Key Metrics\\n\\n')\n    f.write('| Metric\
        \ | Value |\\n')\n    f.write('|--------|-------|\\n')\n    f.write(f'| ‚≠ê\
        \ Stars | {health_data[\"repository\"][\"stars\"]} |\\n')\n    f.write(f'|\
        \ \U0001F374 Forks | {health_data[\"repository\"][\"forks\"]} |\\n')\n   \
        \ f.write(f'| \U0001F440 Watchers | {health_data[\"repository\"][\"watchers\"\
        ]} |\\n')\n    f.write(f'| \U0001F4DD Open Issues | {health_data[\"issues\"\
        ][\"open\"]} |\\n')\n    f.write(f'| ‚úÖ Closed Issues | {health_data[\"issues\"\
        ][\"closed\"]} |\\n')\n    f.write(f'| \U0001F504 Open PRs | {health_data[\"\
        pull_requests\"][\"open\"]} |\\n')\n    f.write(f'| \U0001F49A Commits (7\
        \ days) | {health_data[\"commits\"][\"this_week\"]} |\\n')\n    f.write(f'|\
        \ \U0001F465 Contributors | {health_data[\"contributors\"]} |\\n\\n')\n  \
        \  \n    f.write('## \U0001F4BB Language Distribution\\n\\n')\n    total_bytes\
        \ = sum(health_data[\"languages\"].values())\n    for lang, bytes_count in\
        \ sorted(health_data[\"languages\"].items(), key=lambda x: x[1], reverse=True):\n\
        \        percentage = (bytes_count / total_bytes * 100) if total_bytes > 0\
        \ else 0\n        f.write(f'- **{lang}**: {percentage:.1f}%\\n')\n    \n \
        \   f.write('\\n## \U0001F3AF Health Score\\n\\n')\n    # Calculate simple\
        \ health score\n    score = 0\n    if health_data[\"commits\"][\"this_week\"\
        ] > 0:\n        score += 25\n    if health_data[\"issues\"][\"open\"] < 10:\n\
        \        score += 25\n    if health_data[\"pull_requests\"][\"open\"] < 5:\n\
        \        score += 25\n    if health_data[\"contributors\"] > 1:\n        score\
        \ += 25\n    \n    if score >= 75:\n        status = '\U0001F7E2 Excellent'\n\
        \    elif score >= 50:\n        status = '\U0001F7E1 Good'\n    else:\n  \
        \      status = '\U0001F534 Needs Attention'\n    \n    f.write(f'**Overall\
        \ Health:** {status} ({score}/100)\\n\\n')\n    \n    f.write('## ‚úÖ Recommendations\\\
        n\\n')\n    if health_data[\"commits\"][\"this_week\"] == 0:\n        f.write('-\
        \ ‚ö†Ô∏è No commits this week - consider regular updates\\n')\n    if health_data[\"\
        issues\"][\"open\"] > 10:\n        f.write('- ‚ö†Ô∏è High number of open issues\
        \ - prioritize triage\\n')\n    if health_data[\"pull_requests\"][\"open\"\
        ] > 5:\n        f.write('- ‚ö†Ô∏è Multiple pending PRs - review and merge\\n')\n\
        \    if score == 100:\n        f.write('- ‚úÖ Repository is in excellent health!\\\
        n')\n    \n    f.write('\\n---\\n')\n    f.write('*Automated health check\
        \ by Eliza Agent*\\n')\n\nprint(f'‚úÖ Health check report created: {report_file}')\n\
        print(f'Health Score: {score}/100')\nEOF\n"
    - name: üìä Check for changes
      id: check_changes
      run: "git add .\nif git diff --staged --quiet; then\n  echo \"changes=false\"\
        \ >> $GITHUB_OUTPUT\nelse\n  echo \"changes=true\" >> $GITHUB_OUTPUT\nfi\n"
    - name: üíæ Commit health check
      if: steps.check_changes.outputs.changes == 'true'
      run: 'git config user.name "Eliza Health Monitor"

        git config user.email "health@xmrt-ecosystem.io"

        CHECK_DATE=$(date -u ''+%Y%m%d'')

        git add ${{ env.HEALTH_DIR }}

        git commit -m "üè• Repository Health Check #$CHECK_DATE [automated]


        ‚úÖ Repository metrics collected

        üìä Health score calculated

        üí° Recommendations generated


        Agent: Eliza (Health Monitor)

        Generated by: XMRT Autonomous Health System"

        git push

        '
    - name: üìà Create workflow summary
      if: always()
      run: "CHECK_DATE=$(date -u '+%Y%m%d')\necho \"## \U0001F3E5 Repository Health\
        \ Check Complete\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"**Check Date:** $CHECK_DATE\" >> $GITHUB_STEP_SUMMARY\necho \"**Status:**\
        \ ‚úÖ Complete\" >> $GITHUB_STEP_SUMMARY\necho \"**Timestamp:** $(date -u '+%Y-%m-%d\
        \ %H:%M:%S UTC')\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        \nif [ -f \"${{ env.HEALTH_DIR }}/health_metrics.json\" ]; then\n  echo \"\
        ### \U0001F4CA Quick Stats\" >> $GITHUB_STEP_SUMMARY\n  python3 << 'PYEOF'\n\
        import json\nwith open('${{ env.HEALTH_DIR }}/health_metrics.json', 'r') as\
        \ f:\n    data = json.load(f)\n    print(f\"- ‚≠ê Stars: {data['repository']['stars']}\"\
        )\n    print(f\"- \U0001F374 Forks: {data['repository']['forks']}\")\n   \
        \ print(f\"- \U0001F4DD Open Issues: {data['issues']['open']}\")\n    print(f\"\
        - \U0001F49A Commits (7d): {data['commits']['this_week']}\")\nPYEOF\nfi\n\n\
        echo \"\" >> $GITHUB_STEP_SUMMARY\necho \"**Next Check:** In 12 hours (automatic)\"\
        \ >> $GITHUB_STEP_SUMMARY\n"
permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: read
